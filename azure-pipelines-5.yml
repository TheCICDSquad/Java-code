trigger:
- main

pool:
  name: Linux_Agent

variables:
  MAVEN_DIR: $(Agent.TempDirectory)/maven
  MAVEN_CACHE: $(Pipeline.Workspace)/.m2
  SOURCE_DIR: $(Build.SourcesDirectory)/Helm/Pet_clinic_project/spring-petclinic
  IMAGE_NAME: yourdockerhubusername/petclinic  # Replace with your Docker Hub username
  IMAGE_TAG: $(Build.BuildId)

steps:
- checkout: self

# Cache Maven local repo
- task: Cache@2
  inputs:
    key: 'maven | "$(Agent.OS)" | $(SOURCE_DIR)/pom.xml'
    path: $(MAVEN_CACHE)
  displayName: 'Cache Maven local repo'

# Download Maven
- script: |
    curl -L https://archive.apache.org/dist/maven/maven-3/3.9.4/binaries/apache-maven-3.9.4-bin.tar.gz -o $(Agent.TempDirectory)/maven.tar.gz
  displayName: 'Download Maven'

# Extract Maven
- script: |
    mkdir -p $(MAVEN_DIR)
    tar -xzf $(Agent.TempDirectory)/maven.tar.gz -C $(MAVEN_DIR)
  displayName: 'Extract Maven'

# Maven build
- script: |
    export MAVEN_HOME=$(MAVEN_DIR)/apache-maven-3.9.4
    export PATH=$MAVEN_HOME/bin:$PATH
    cd $(SOURCE_DIR)
    mvn clean install -B -Dmaven.repo.local=$(MAVEN_CACHE)
  displayName: 'Run Maven Build'

# Publish JAR
- publish: $(SOURCE_DIR)/target
  artifact: petclinic-jar-$(Build.BuildId)
  displayName: 'Publish JAR Artifact'

# Verify Dockerfile exists
- script: |
    echo "Checking Dockerfile at: $(SOURCE_DIR)/Dockerfile"
    if [ ! -f "$(SOURCE_DIR)/Dockerfile" ]; then
      echo "##vso[task.logissue type=error]Dockerfile not found at $(SOURCE_DIR)/Dockerfile"
      exit 1
    fi
    ls -la $(SOURCE_DIR)/Dockerfile
  displayName: 'Verify Dockerfile Exists'

# Docker login (using service connection - recommended)
- task: Docker@2
  displayName: 'Login to Docker Hub'
  inputs:
    command: login
    containerRegistry: dockerHubService  # Must match your service connection name

# Build Docker image with explicit path
- script: |
    cd $(SOURCE_DIR)
    docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .
  displayName: 'Build Docker Image'

# Push Docker image
- script: |
    docker push $(IMAGE_NAME):$(IMAGE_TAG)
  displayName: 'Push Docker Image'